# ğŸ« NFT Ticketing - Test Flow Fields Documentation

## Overview
File `test-flow-guide.html` Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t vá»›i **Äáº¦Y Äá»¦ Táº¤T Cáº¢ CÃC TRÆ¯á»œNG** tá»« database schema.

---

## ğŸ“ STEP 1: Connect MetaMask Wallet
**Má»¥c Ä‘Ã­ch:** Káº¿t ná»‘i vÃ­ MetaMask Ä‘á»ƒ kÃ½ giao dá»‹ch blockchain

### TrÆ°á»ng dá»¯ liá»‡u:
- `wallet_address` (auto-detected from MetaMask)

---

## âœï¸ STEP 2: Sign Message & Register User
**Má»¥c Ä‘Ã­ch:** XÃ¡c thá»±c ngÆ°á»i dÃ¹ng vÃ  táº¡o tÃ i khoáº£n trong database

### TrÆ°á»ng dá»¯ liá»‡u (báº£ng `users`):
- âœ… `id` (UUID) - Auto-generated
- âœ… `wallet_address` (VARCHAR(42)) - From MetaMask
- `username` (VARCHAR(50)) - Optional, can be added later
- `email` (VARCHAR(255)) - Optional
- `avatar_url` (TEXT) - Optional
- `bio` (TEXT) - Optional
- âœ… `created_at` (TIMESTAMP) - Auto-generated
- âœ… `updated_at` (TIMESTAMP) - Auto-generated

### API Response:
```json
{
  "user": {
    "id": "uuid-here",
    "wallet_address": "0x...",
    "created_at": "2025-01-01T00:00:00Z"
  }
}
```

---

## ğŸ‰ STEP 3: Create Event
**Má»¥c Ä‘Ã­ch:** Táº¡o sá»± kiá»‡n vá»›i Ä‘áº§y Ä‘á»§ metadata

### TrÆ°á»ng dá»¯ liá»‡u (báº£ng `events`):
#### Required Fields:
- âœ… `title` (VARCHAR(255)) - Event name
- âœ… `start_date` (TIMESTAMP WITH TIME ZONE) - ISO 8601 format
- âœ… `end_date` (TIMESTAMP WITH TIME ZONE) - ISO 8601 format
- âœ… `location` (TEXT) - City or general location
- âœ… `venue_name` (VARCHAR(255)) - Specific venue name
- âœ… `category` (VARCHAR(50)) - concert, sports, conference, festival, theater, exhibition, other
- âœ… `total_supply` (INTEGER) - Total number of tickets

#### Optional Fields:
- âœ… `description` (TEXT) - Event description
- âœ… `banner_url` (TEXT) - Large banner image (1920x1080 recommended)
- âœ… `thumbnail_url` (TEXT) - Thumbnail image (600x400 recommended)
- âœ… `royalty_fee` (INTEGER) - Basis points (500 = 5%, max 10000)
- âœ… `contract_address` (VARCHAR(42)) - Auto-filled if minting
- âœ… `is_published` (BOOLEAN) - Default true
- `is_active` (BOOLEAN) - Default true (backend handles)
- `total_sold` (INTEGER) - Auto-updated (backend handles)

#### Auto-generated Fields:
- âœ… `id` (UUID) - Primary key
- âœ… `organizer_id` (UUID) - From Step 2
- âœ… `event_id_onchain` (BIGINT) - Set when minting first ticket
- âœ… `created_at` (TIMESTAMP)
- âœ… `updated_at` (TIMESTAMP)

### API Request:
```json
{
  "organizer_id": "user-uuid",
  "title": "Amazing Concert 2025",
  "description": "The most amazing concert...",
  "category": "concert",
  "start_date": "2025-12-31T20:00:00Z",
  "end_date": "2025-12-31T23:59:00Z",
  "location": "New York City",
  "venue_name": "Madison Square Garden",
  "total_supply": 1000,
  "banner_url": "https://...",
  "thumbnail_url": "https://...",
  "royalty_fee": 500,
  "is_published": true
}
```

---

## ğŸ« STEP 4: Mint Ticket NFT
**Má»¥c Ä‘Ã­ch:** Mint NFT ticket trÃªn blockchain

### TrÆ°á»ng dá»¯ liá»‡u (báº£ng `tickets`):
#### Required:
- âœ… `event_id` (UUID) - From Step 3
- âœ… `user_wallet` (VARCHAR(42)) - Recipient address

#### Optional in UI:
- âœ… `metadata_uri` (TEXT) - IPFS or storage URL for NFT metadata

#### Auto-generated by Backend/Indexer:
- âœ… `id` (UUID) - Primary key
- âœ… `token_id` (BIGINT) - From blockchain event
- âœ… `template_id` (UUID) - References ticket_templates (backend creates default)
- âœ… `owner_wallet` (VARCHAR(42)) - From mint event
- âœ… `original_owner` (VARCHAR(42)) - First minter
- âœ… `status` (ENUM) - 'minted' initially
- âœ… `tx_hash` (VARCHAR(66)) - Transaction hash
- `qr_code_url` (TEXT) - Generated for check-in
- `qr_hash` (VARCHAR(64)) - SHA256 for validation
- `is_checked_in` (BOOLEAN) - Default false
- `is_transferable` (BOOLEAN) - Default true
- âœ… `minted_at` (TIMESTAMP)
- âœ… `updated_at` (TIMESTAMP)

### API Request:
```json
{
  "event_id": "event-uuid",
  "user_wallet": "0x...",
  "metadata_uri": "ipfs://..." // optional
}
```

### API Response:
```json
{
  "transactionHash": "0x...",
  "tokenId": "1",
  "message": "Ticket minted successfully"
}
```

---

## ğŸª STEP 5: List Ticket on Marketplace
**Má»¥c Ä‘Ã­ch:** List ticket for resale

### TrÆ°á»ng dá»¯ liá»‡u (báº£ng `marketplace_listings`):
#### Required:
- âœ… `token_id` (BIGINT) - From Step 4
- âœ… `price_token` (NUMERIC(20,2)) - Price in ETH/Token

#### Optional:
- âœ… `seller_wallet` (VARCHAR(42)) - Defaults to connected wallet

#### Auto-generated:
- âœ… `id` (UUID) - Primary key
- âœ… `ticket_id` (UUID) - References tickets table
- âœ… `status` (ENUM) - 'active' initially
- âœ… `tx_hash` (VARCHAR(66)) - Blockchain transaction
- âœ… `listed_at` (TIMESTAMP)
- `sold_at` (TIMESTAMP) - Set when sold
- `cancelled_at` (TIMESTAMP) - Set when cancelled
- `buyer_wallet` (VARCHAR(42)) - Set when sold
- âœ… `updated_at` (TIMESTAMP)

### API Request:
```json
{
  "tokenId": "1",
  "price": "0.1",
  "seller_wallet": "0x..." // optional
}
```

---

## ğŸ’° STEP 6: Buy Ticket from Marketplace
**Má»¥c Ä‘Ã­ch:** Purchase listed ticket

### TrÆ°á»ng dá»¯ liá»‡u:
#### Required:
- âœ… `token_id` (BIGINT) - Token to purchase
- âœ… `buyer_address` (VARCHAR(42)) - Buyer wallet

#### Optional:
- âœ… `amount` (NUMERIC) - Payment amount (auto-fetched from listing if omitted)

### API Request:
```json
{
  "tokenId": "1",
  "buyerAddress": "0x...",
  "amount": "0.1" // optional
}
```

### Database Updates:
- `marketplace_listings.status` â†’ 'sold'
- `marketplace_listings.sold_at` â†’ current timestamp
- `marketplace_listings.buyer_wallet` â†’ buyer address
- `tickets.owner_wallet` â†’ buyer address
- `tickets.status` â†’ 'sold'
- New row in `transactions` table

---

## âœ… STEP 7: Check-in at Event
**Má»¥c Ä‘Ã­ch:** Validate ticket at venue entrance

### TrÆ°á»ng dá»¯ liá»‡u (báº£ng `checkin_logs`):
#### Required:
- âœ… `token_id` (BIGINT) - Ticket to check-in

#### Optional:
- âœ… `scanned_by` (UUID) - Staff user ID (defaults to current user)
- âœ… `device_info` (JSONB) - Device metadata
- âœ… `location_info` (JSONB) - GPS coordinates

#### Auto-generated:
- âœ… `id` (UUID) - Primary key
- âœ… `ticket_id` (UUID) - References tickets table
- âœ… `event_id` (UUID) - From ticket
- `scanned_wallet` (VARCHAR(42)) - If no user account
- âœ… `timestamp` (TIMESTAMP) - Check-in time

### API Request:
```json
{
  "tokenId": "1",
  "scanned_by": "user-uuid", // optional
  "device_info": {
    "device": "iPad Pro",
    "app_version": "1.0",
    "os": "iOS 17"
  }, // optional
  "location_info": {
    "lat": 40.7505,
    "lng": -73.9934,
    "venue": "MSG",
    "accuracy": 10
  } // optional
}
```

### Database Updates:
- `tickets.is_checked_in` â†’ true
- `tickets.checked_in_at` â†’ current timestamp
- `tickets.checked_in_by` â†’ scanner user ID
- `tickets.status` â†’ 'checked_in'
- New row in `checkin_logs` table
- New blockchain transaction in `transactions` table

---

## ğŸ“Š STEP 8: View System Data
**Má»¥c Ä‘Ã­ch:** Query and analyze system data

### Available Queries:
1. âœ… **View All Events** - `GET /api/events`
2. âœ… **View All Tickets** - `GET /api/tickets?event_id=...&owner_wallet=...`
3. âœ… **View Marketplace** - `GET /api/marketplace/listings`
4. âœ… **View Check-in Logs** - `GET /api/checkin/logs?event_id=...`
5. âœ… **View Transactions** - `GET /api/transactions?wallet=...`
6. âœ… **View Event Stats** - `GET /api/events/stats?event_id=...`

### Filter Options:
- âœ… `event_id` (UUID) - Filter by specific event
- âœ… `owner_wallet` / `wallet` (VARCHAR(42)) - Filter by wallet address

---

## ğŸ“‹ Summary: All Database Tables Covered

### âœ… FULLY COVERED:
1. **users** - Step 2 (Auth & Register)
2. **events** - Step 3 (Create Event)
3. **tickets** - Step 4 (Mint Ticket)
4. **marketplace_listings** - Steps 5-6 (List & Buy)
5. **checkin_logs** - Step 7 (Check-in)
6. **transactions** - Auto-recorded by indexer for all blockchain txs

### ğŸ”„ PARTIALLY COVERED (Backend Auto-handles):
7. **ticket_templates** - Auto-created by backend when minting
8. **event_analytics** - Auto-updated by backend/triggers
9. **whitelist** - Not yet implemented in UI (future feature)

---

## ğŸ¯ Key Features

### Database Schema Alignment:
- âœ… All required fields have form inputs
- âœ… All optional fields are available
- âœ… Auto-generated fields are documented
- âœ… Foreign key relationships are handled

### User Experience:
- âœ… Clear labels with data type hints
- âœ… Placeholder text with examples
- âœ… Default values for quick testing
- âœ… Required fields marked with *
- âœ… Helpful tooltips and info boxes

### Developer Features:
- âœ… Copy buttons for UUIDs and hashes
- âœ… JSON formatting in response boxes
- âœ… Progress tracking
- âœ… Error handling with clear messages
- âœ… Debug functions (View All Users)

---

## ğŸš€ How to Test Complete Flow

1. **Ensure services are running:**
   ```bash
   # Terminal 1: REST API
   cd backend/rest-api
   npm run dev

   # Terminal 2: Indexer
   cd backend/indexer
   npm run dev
   ```

2. **Open test interface:**
   ```
   Open test-flow-guide.html in browser
   ```

3. **Complete all 8 steps sequentially**

4. **Verify in Supabase:**
   - Check `users` table for new user
   - Check `events` table for event with all metadata
   - Check `tickets` table for minted ticket (wait 10-30s for indexer)
   - Check `marketplace_listings` for active listing
   - Check `checkin_logs` for check-in record
   - Check `transactions` for blockchain history

---

## ğŸ“ Notes

- All timestamps are in ISO 8601 format with timezone
- All wallet addresses are checksummed (lowercase in DB)
- All prices are in NUMERIC(20,2) for precision
- All blockchain transaction hashes are 66 characters (0x + 64 hex)
- UUIDs are version 4 (uuid_generate_v4())
- JSONB fields support flexible metadata without schema changes

---

**Last Updated:** 2025-01-18
**Version:** 2.0.0 (Complete with all database fields)
